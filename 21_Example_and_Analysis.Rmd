---
title: "21_Example_and_Analysis"
date: "`r Sys.Date()`"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.width = 7,
                      fig.height = 5)
```


```{r}
library(dplyr)
library(ggplot2)
library(qgraph)

# make sure results folder exists
if (!dir.exists("results")) dir.create("results")
```

```{r}
# load the csv created by 02_Method file
all_res <- read.csv("results/all_results.csv")

# load functions so run_one_sim() can be called for network plots
source("01_DataSimulation.R")
```

# 1. Summary tables

```{r}
# summary for A (contemporaneous)
summary_A <- all_res %>%
  dplyr::filter(matrix == "A") %>%
  dplyr::group_by(T_obs) %>%
  dplyr::summarise(
    
    mean_TPR = mean(sensitivity, na.rm = TRUE), # TPR
    sd_TPR = sd(sensitivity, na.rm = TRUE),

    mean_FPR = mean(FPR, na.rm = TRUE),
    sd_FPR = sd(FPR, na.rm = TRUE),

    mean_spec = mean(specificity, na.rm = TRUE),
    sd_spec = sd(specificity, na.rm = TRUE),

    # average counts of FP and FN
    mean_FP = mean(FP, na.rm = TRUE),
    sd_FP = sd(FP, na.rm = TRUE),

    mean_FN = mean(FN, na.rm = TRUE),
    sd_FN = sd(FN, na.rm = TRUE),

    # false negative rate (FNR)
    mean_FNR = mean(FN / (TP + FN), na.rm = TRUE),
    sd_FNR = sd(FN / (TP + FN), na.rm = TRUE),

    .groups = "drop"
    
  )
summary_A

# summary for Phi (lagged)
summary_Phi <- all_res %>%
  dplyr::filter(matrix == "Phi") %>%
  dplyr::group_by(T_obs) %>%
  dplyr::summarise(
    mean_TPR = mean(sensitivity, na.rm = TRUE),
    sd_TPR = sd(sensitivity, na.rm = TRUE),
    .groups = "drop"
  )
summary_Phi
```

# 2. TPR vs. T for A and Phi

```{r}
p_tpr_both <- ggplot() +
  geom_line(data = summary_A,
            aes(x = T_obs,
                y = mean_TPR,
                color = "A")) +
  geom_point(data = summary_A,
             aes(x = T_obs,
                 y = mean_TPR,
                 color = "A")) +
  geom_line(data = summary_Phi,
            aes(x = T_obs,
                y = mean_TPR,
                color = "Phi")) +
  geom_point(data = summary_Phi,
             aes(x = T_obs,
                 y = mean_TPR,
                 color = "Phi")) +
  labs(
    x = "T (time points per subject)",
    y = "True Positive Rate (TPR)",
    color = "Matrix",
    title = "TPR vs. T for A and Phi"
    ) +
  theme_minimal()

ggsave("results/TPR_vs_T_A_Phi_analysis.png",
       plot = p_tpr_both,
       width = 7,
       height = 5,
       dpi = 300)
```

# 3. A recovery across T

```{r}
# TPR for A with error bars
p_tpr_A <- ggplot(summary_A,
                  aes(x = T_obs,
                      y = mean_TPR)) +
  geom_line() +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_TPR - sd_TPR,
                    ymax = mean_TPR + sd_TPR),
                width = 10) +
  labs(
    x = "T (time points per subject)",
    y = "True Positive Rate (TPR) for A",
    title = "Group-level Recovery of Contemporaneous Edges (A)"
    ) +
  theme_minimal()

ggsave("results/TPR_A_errorbars_analysis.png",
       plot = p_tpr_A,
       width = 7,
       height = 5,
       dpi = 300)
```

# 4. Network plots

```{r}
# getting one sample simulation from each T
run_50  <- run_one_sim(T_obs = 50,
                       N = 100,
                       p = 8,
                       group_cutoff = 0.75,
                       seed = 1050,
                       burn_in = 100,
                       return_nets = TRUE)

run_150 <- run_one_sim(T_obs = 150,
                       N = 100,
                       p = 8,
                       group_cutoff = 0.75,
                       seed = 1150,
                       burn_in = 100,
                       return_nets = TRUE)

run_300 <- run_one_sim(T_obs = 300,
                       N = 100,
                       p = 8,
                       group_cutoff = 0.75,
                       seed = 1300,
                       burn_in = 100,
                       return_nets = TRUE)
```

## 4.1 True vs. estimated network for A

```{r}
par(mfrow = c(2, 3))  

# T = 50, A matrices
set.seed(1)
layout_A50 <- qgraph(run_50$A_common,
                     layout = "spring",
                     DoNotPlot = TRUE)$layout

qgraph(run_50$A_common,
       layout = layout_A50,
       edge.labels = TRUE,
       title = "True A, T = 50")

qgraph(run_50$A_est,
       layout = layout_A50,
       edge.labels = TRUE,
       title = "Estimated A, T = 50")

#  T = 150, A matrices 
set.seed(2)
layout_A150 <- qgraph(run_150$A_common,
                      layout = "spring",
                      DoNotPlot = TRUE)$layout

qgraph(run_150$A_common,
       layout = layout_A150,
       edge.labels = TRUE,
       title = "True A, T = 150")

qgraph(run_150$A_est,
       layout = layout_A150,
       edge.labels = TRUE,
       title = "Estimated A, T = 150")

# T = 300, A matrices 
set.seed(3)
layout_A300 <- qgraph(run_300$A_common,
                      layout = "spring",
                      DoNotPlot = TRUE)$layout

qgraph(run_300$A_common,
       layout = layout_A300,
       edge.labels = TRUE,
       title = "True A, T = 300")

qgraph(run_300$A_est,
       layout = layout_A300,
       edge.labels = TRUE,
       title = "Estimated A, T = 300")

par(mfrow = c(1,1))  # reset
```

## 4.2 True vs. estimated network for $\Phi$

```{r}
par(mfrow = c(2, 3))

# T = 50, Phi 
set.seed(4)
layout_Phi50 <- qgraph(run_50$Phi_common,
                       layout = "spring",
                       DoNotPlot = TRUE)$layout

qgraph(run_50$Phi_common,
       layout = layout_Phi50,
       edge.labels = TRUE,
       title = "True Phi, T = 50")

qgraph(run_50$Phi_est,
       layout = layout_Phi50,
       edge.labels = TRUE,
       title = "Estimated Phi, T = 50")

# T = 150, Phi 
set.seed(5)
layout_Phi150 <- qgraph(run_150$Phi_common,
                        layout = "spring",
                        DoNotPlot = TRUE)$layout

qgraph(run_150$Phi_common,
       layout = layout_Phi150,
       edge.labels = TRUE,
       title = "True Phi, T = 150")

qgraph(run_150$Phi_est,
       layout = layout_Phi150,
       edge.labels = TRUE,
       title = "Estimated Phi, T = 150")

# T = 300, Phi
set.seed(6)
layout_Phi300 <- qgraph(run_300$Phi_common,
                        layout = "spring",
                        DoNotPlot = TRUE)$layout

qgraph(run_300$Phi_common,
       layout = layout_Phi300,
       edge.labels = TRUE,
       title = "True Phi, T = 300")

qgraph(run_300$Phi_est,
       layout = layout_Phi300,
       edge.labels = TRUE,
       title = "Estimated Phi, T = 300")

par(mfrow = c(1,1)) # reset
```
